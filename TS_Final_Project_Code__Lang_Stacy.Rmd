---
title: "Time Series Study on CO2 Emissions and Hybrid Car Sales Project"
author: "Grace Lang & Jules Stacy"
date: "3/18/2021"
output: html_document
---

# Business Objective: 
Taking care of our environment now will help our health and the health of future generations. Air pollution from vehicle CO2 Emissions can cause respiratory diseases and cancer. 

In addition to emitting less CO2, hybrid cars have had sales on the rise in recent years due to their fuel efficiency and environmental benefits.

Popularity of wind turbines have also increased over time as more landowners are willing to get them installed on their land for energy rights and economic benefit. 
Our mission is to identify and provide insights of macro trends within the environmental industry. 



# Data sources: 
* Hybrid Car sales: https://afdc.energy.gov/data/10301
* CO2 Emissions by Country: https://data.worldbank.org/indicator/EN.ATM.CO2E.PC?view=map
* Turbine data citation: https://doi.org/10.5066/F7TX3DN0


```{r}
# install.packages('PerformanceAnalytics')
```


```{r setup, include=FALSE}
## Packages to load:
library(tswge)
library(dplyr)
library(DataCombine)
library(PerformanceAnalytics)
library(vars)
library(nnfor)
```

## Rolling Window ASE Function:
```{r}
R_W_ASE = function(series, trainingSize, horizon=1, s=0, d=0, phis=0, thetas=0)
{
  trainingSize=trainingSize
  horizon=horizon
  ASEHolder=numeric()
  s=s
  d=d
  phis=phis
  thetas=thetas

for( i in 1:(length(series)-(trainingSize + horizon) + 1))
{
  forecasts = fore.aruma.wge(series[i:(i+(trainingSize-1))], phi=phis, theta=thetas, s=s, d=d, n.ahead=horizon)

  ASE=mean((series[(trainingSize+i):(trainingSize + i + (horizon) - 1)] - forecasts$f)^2)
  print(paste0('i: ', i))
  print(paste0('ASE: ', ASE))
  ASEHolder[i] = ASE
}
  ASEHolder
  hist(ASEHolder)
  WindowedASE = mean(ASEHolder)

  print("The Summary Statistics for the Rolling Window ASE Are:")
  print(summary(ASEHolder))
  print(paste("The Rolling Window ASE is: ", WindowedASE))
  return(WindowedASE)
}
```

# Loading in data & cleanup:
```{r}
#Loading in the CO2 Emission data
car_orig <- read.csv("./HybridCar.csv")
#Remove years that are majority blank
car <- car_orig[40:60,] #This may not be used in the modeling

#Rename column to something easier
names(car)[names(car) == "CO2.emissions..metric.tons.per.capita."] <- "CO2"

#Loading in the wind turbine data
turbine <- read.csv("./turbines.csv")
turbine_tot = aggregate(turbine$p_tnum, by=list(Category=turbine$p_year), FUN=sum)
turbine_tot
#Renaming wind turbine column
names(turbine_tot)[names(turbine_tot) == "x"] <- "wind"
plotts.sample.wge(turbine_tot$wind)


# Data cleanup

#turbine data is missing 1993
x<- turbine_tot[1:35,]
x<- x %>% add_row(Category = 1993, wind = 0, .before = 13)
#shorten to just the years with cross-over data
y<- car_orig[22:57,1:3]
#combine the 2 datasets
alldata <- cbind(x,y)
#alldata <- select(alldata,-USA) #remove duplicate year column that was for reference
#Rename column to something easier
names(alldata)[names(alldata) == "CO2.emissions..metric.tons.per.capita."] <- "CO2"
```


# Initial look at data plotted out
Data cut differently by years to see if we need to subset the data for a specific timeframe. 
```{r}
plotts.wge(car$CO2)
plotts.wge(car$TotalSales)

car_1 <- car_orig[40:57,]
plotts.sample.wge(car_1$CO2)

co2_total <- car_orig[1:57,]
names(co2_total)[names(co2_total) == "CO2.emissions..metric.tons.per.capita."] <- "CO2"
plotts.sample.wge(co2_total$CO2)

length_CO2 = length(co2_total$CO2)
```


# ARMA Model #1:
```{r}
#ARIMA Model Plotting
plotts.sample.wge(co2_total$CO2)
aic5.wge(co2_total$CO2,p=0:10) #AIC shows an ARMA(1,1) s best fit 
aic5.wge(co2_total$CO2, type="bic") #BIC shows an ARMA(1,1) s best fit 

#fit the model -- ARMA(1.1)
est.arma.wge(co2_total$CO2, p=1, q=1)
m1 = fore.arma.wge(co2_total$CO2,phi=0.9261945,theta = -0.5741199 , n.ahead = 5,lastn=TRUE,  plot=TRUE)
mean((co2_total$CO2[53:57]-m1$f)^2)
#ASE =  0.8390832

# #Using the ARMA(1,1) to plot the 5 years ahead
# fore.arma.wge(co2_total$CO2,phi=0.9261945,theta = -0.5741199 , n.ahead = 5,lastn=FALSE,  plot=TRUE)
# #Using the ARMA(1,1) to plot the 20 years ahead
# fore.arma.wge(co2_total$CO2,phi=0.9261945,theta = -0.5741199 , n.ahead = 20,lastn=FALSE,  plot=TRUE)


#ASE's and Forecasts ================
#5 years out
n.ahead=5
CO2_f = fore.aruma.wge(x=co2_total$CO2, phi=0.9261945, theta=-0.5741199, n.ahead=n.ahead, lastn=TRUE)
#calculate ASE
ASE_ar11 = mean((CO2_f$f - co2_total$CO2[(length_CO2-n.ahead):length_CO2])^2)
#display ASE
print(paste0("5 year: ", ASE_ar11))

#forecast
fore.aruma.wge(x=co2_total$CO2, phi=0.9261945, theta=-0.5741199, n.ahead=n.ahead, lastn=FALSE)

#20 years out
n.ahead=20
CO2_f = fore.aruma.wge(x=co2_total$CO2, phi=0.9261945, theta=-0.5741199, n.ahead=n.ahead, lastn=TRUE)
#calculate ASE
ASE_ar11 = mean((CO2_f$f - co2_total$CO2[(length_CO2-n.ahead):length_CO2])^2)
#display ASE
print(paste0("20 year: ", ASE_ar11))

#forecast
fore.aruma.wge(x=co2_total$CO2, phi=0.9261945, theta=-0.5741199, n.ahead=n.ahead, lastn=FALSE)



#rolling window ASE
R_W_ASE(co2_total$CO2, phis=0.9261945, thetas=-0.5741199, trainingSize=20, horizon=5)
```


# ARIMA Model #2:
```{r}
#remove a D term
factor.wge(phi=c(rep(0, 9), 1))
est.arma.wge(co2_total$CO2, p=14)

#differencing a d=1 seasonal component
co2_diff = artrans.wge(co2_total$CO2, phi.tr=c(1))
#fit the differenced data
aic5.wge(co2_diff) #AR(0,1) recommended
co2_diff_est = est.arma.wge(co2_diff, 0, 1) #est AR(0,1) on differenced data
co2_diff_est
#check residuals
ljung.wge(co2_diff_est$res, K=24) #p = 0.940, > 0.05
ljung.wge(co2_diff_est$res, K=48) #p = 0.303, > 0.05
#residuals appear to be whitened



#ASE's and Forecasts
#5 years out
n.ahead=5
CO2_f = fore.aruma.wge(x=co2_total$CO2, phi=0, theta=c(-0.5532092), d=1, s=0, n.ahead=n.ahead, lastn=TRUE)
#calculate ASE
ASE_ar011 = mean((CO2_f$f - co2_total$CO2[(length_CO2-n.ahead):length_CO2])^2)
#display ASE
ASE_ar011

#forecast
fore.aruma.wge(x=co2_total$CO2, phi=0, theta=c(-0.5532092), d=1, s=0, n.ahead=n.ahead, lastn=FALSE)

#20 years out
n.ahead=20
CO2_f = fore.aruma.wge(x=co2_total$CO2, phi=0, theta=c(-0.5532092), d=1, s=0, n.ahead=n.ahead, lastn=TRUE)
#calculate ASE
ASE_ar011 = mean((CO2_f$f - co2_total$CO2[(length_CO2-n.ahead):length_CO2])^2)
#display ASE
ASE_ar011

#forecast
fore.aruma.wge(x=co2_total$CO2, phi=0, theta=c(-0.5532092), d=1, s=0, n.ahead=n.ahead, lastn=FALSE)



#rolling window ASE
R_W_ASE(co2_total$CO2, trainingSize=20, horizon=5, s=0, d=1, thetas=c(-0.5532092), phis=0)
```

# VAR Model with additions of the wind turbine & hybrid car sales data:

## Question for Sadler - i run the ASE off of past data, but then i have to reforecast with it looking ahead?
```{r}
# A selection of the data from the 3 datasets will be used for the VAR model. 
  #All NA's will be replaced with 0
alldata[is.na(alldata)] = 0
length_all = length(alldata$CO2)

#VARS
VARselect(alldata$CO2, type = "const",season = NULL, exogen = NULL)
#VARselect picks p=1 (using BIC SC(n))
var1 = VAR(cbind(alldata$CO2,alldata$wind, alldata$TotalSales), type = "both", lag.max = NULL)
  AIC(var1)

#5 year ahead
n.ahead=5
preds5 = predict(var1,n.ahead = n.ahead)
#ASE
mean((preds5$fcst$y1 - alldata$CO2[(length_all-(n.ahead-1)):length_all])^2)

#20 year ahead
n.ahead=20
preds20 = predict(var1,n.ahead = n.ahead)
#ASE
mean((preds20$fcst$y1 - alldata$CO2[(length_all-(n.ahead-1)):length_all])^2)

#Plotting out the 5 Year
plot(seq(1,36,1),alldata$CO2,type="b", xlim=c(1,41), ylab="CO2 Emissions",main="VAR - 5 Year Forecast")
points(seq(37,41,1),preds5$fcst$y1[,1],type="b",pch=15)

#Plotting out the 20 Year
plot(seq(1,36,1),alldata$CO2,type="b", xlim=c(1,56), ylim =c(14,21), ylab="CO2 Emissions",main="VAR - 20 Year Forecast")
points(seq(37,56,1),preds20$fcst$y1[,1],type="b",pch=15)

#rolling window ASE
#R_W_ASE(co2_total$CO2, trainingSize=20, horizon=5, s=0, d=1, thetas=c(-0.5532092), phis=0)
```

# Univariate MLP Model: 
```{r}
co2_all = ts(alldata$CO2[1:36], start =c(1981,1),frequency =1)
co2_5 = ts(alldata$CO2[1:31], start =c(1981,1),frequency =1)
co2_20 = ts(alldata$CO2[1:16], start =c(1981,1),frequency =1)
##-----------------------------------------------
##        -- Checking it with Mean
##-----------------------------------------------
#Using data minus 5 years
set.seed(2)
fit.mlp = mlp(co2_5,reps = 50,comb="mean")
fit.mlp 
plot(fit.mlp)

#Forecasting out 5 years ahead
fore.mlp = forecast(fit.mlp,h=5)
plot(fore.mlp, ylab="CO2 Emissions",main="MLP - 5 Year Forecast")

# 5yr ASE
mean((fore.mlp$mean - co2_all[32:36])^2)
##-----------------------------------------------
#Using data minus 20 years
set.seed(2)
fit.mlp2 = mlp(co2_20,reps = 50,comb="mean")
fit.mlp2 
plot(fit.mlp2)

#Forecasting out 20 years ahead
fore.mlp2 = forecast(fit.mlp,h=20)
plot(fore.mlp2, ylab="CO2 Emissions",main="MLP - 20 Year Forecast")

# 20 yr ASE
mean((fore.mlp2$mean - co2_all[17:36])^2)
##-----------------------------------------------
##        -- Checking it with Median 
##-----------------------------------------------
#Using data minus 5 years
set.seed(2)
fit.mlp = mlp(co2_5,reps = 50,comb="median")
fit.mlp 
plot(fit.mlp)

#Forecasting out 5 years ahead
fore.mlp = forecast(fit.mlp,h=5)
plot(fore.mlp, ylab="CO2 Emissions",main="MLP - 5 Year Forecast")

# 5yr ASE
mean((fore.mlp$mean - co2_all[32:36])^2)
##-----------------------------------------------
#Using data minus 20 years
set.seed(2)
fit.mlp2 = mlp(co2_20,reps = 50,comb="median")
fit.mlp2 
plot(fit.mlp2)

#Forecasting out 20 years ahead
fore.mlp2 = forecast(fit.mlp,h=20)
plot(fore.mlp2, ylab="CO2 Emissions",main="MLP - 20 Year Forecast")

# 20 yr ASE
mean((fore.mlp2$mean - co2_all[17:36])^2)
```
```


